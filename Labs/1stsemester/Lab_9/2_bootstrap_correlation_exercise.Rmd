---
title: "Bootstrapping 2: Bootstrap for Correlation"
author: "PSY 503"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Setup

```{r}
library(ggplot2)
library(HistData)

data(Galton)
head(Galton)
```

## The Question

What's the correlation between parent height and child height?

And how uncertain are we?

## Part 1: Calculate sample correlation

```{r}
# TODO_1: Calculate correlation between parent and child
#r_obs <- cor(,)
#r_obs
r_obs <- cor(Galton$parent, Galton$child)
r_obs
```

## Part 2: Bootstrap

Resample pairs. Calculate correlation each time.

```{r}
n_boot <- 1000
n <- nrow(Galton)
boot_cors <- replicate(n_boot, {
  # TODO_2: Sample row indices with replacement
  indices = sample(n, replace = TRUE)
  # Calculate correlation on resampled data
  cor(Galton$parent[indices], Galton$child[indices])

})
```

## Part 3: Visualize uncertainty

```{r}
ggplot(data.frame(r = boot_cors), aes(x = r)) +
  geom_histogram(bins = 50, fill = "steelblue") +
  geom_vline(xintercept = r_obs, color = "red", linewidth = 1) +
  labs(title = "Bootstrap Distribution of Correlation",
       x = "Correlation", y = "Count") +
  theme_minimal()
```

## Part 4: Calculate CI

Use percentiles.

```{r}
# TODO: Get 2.5th and 97.5th percentiles
ci_lower <- quantile(boot_cors, 0.025)
ci_upper <- quantile(boot_cors, 0.975)

c(ci_lower, ci_upper)
```

## Part 5: Compare to theory

Formula exists: SE ≈ (1-r²)/√n

```{r}
# Theoretical SE
se_theory <- (1 - r_obs^2) / sqrt(n)
se_theory

# Bootstrap SE
se_boot <- sd(boot_cors)
se_boot
```

How close are they? They are very close, which means the theoretical SE is a good measure, if they weren't, we might need to rely on the bootstrapped SE.

## Questions

1. While computing the bootstrapped correlation (lines 37, 45), why do we resample in pairs?
Why do we not resample any two random values?

In that case you would mix up the measurements, so that the wrong parent and child height's would be matched together.

2. Is the bootstrap distribution normal?

Yes, it is approximately normal.

3. Do theoretical and bootstrap SE match?

They approximately match, they are quite similar.

4. Which is easier to compute?

The SD for the bootstrapped distribution is easier to calculate, even though it's computationally more intensive.

5. What if you wanted CI for r²? Or for difference between two correlations? 
How would you want to calculate those?

You would draw samples for the pairs and calculate the R^2 on each one, and then one could take the percentiles from the bootstrapped distribution. For the difference between two correlations you'd find the difference and calculate it (for some other dataset) using bootstrapping. 


